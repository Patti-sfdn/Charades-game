<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>头顶猜词王 - 多人联机版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Socket.io客户端 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1F2937',
                        light: '#F3F4F6',
                    },
                    fontFamily: {
                        game: ['"Comic Sans MS"', '"Marker Felt"', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            .player-card {
                transition: all 0.3s ease;
            }
            .player-card:hover {
                transform: translateY(-5px);
            }
            .word-appear {
                animation: wordAppear 0.5s ease-out forwards;
            }
            .pulse-button {
                animation: pulse 2s infinite;
            }
            @keyframes wordAppear {
                0% { opacity: 0; transform: translateY(-20px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
                100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
            }
        }
    </style>
    
    <style>
        /* 暗色模式样式 */
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --gray-light: #333;
            --gray-medium: #555;
        }
        
        /* 亮色模式样式 */
        body:not(.dark-mode) {
            --bg-color: #F3F4F6;
            --text-color: #1F2937;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --gray-light: #f3f4f6;
            --gray-medium: #d1d5db;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .bg-white {
            background-color: var(--card-bg);
        }
        
        .border-gray-200, .border-gray-300 {
            border-color: var(--border-color);
        }
        
        .bg-gray-100 {
            background-color: var(--gray-light);
        }
        
        .bg-gray-200 {
            background-color: var(--gray-medium);
        }
        
        .text-gray-500, .text-gray-600, .text-gray-700, .text-gray-800 {
            color: var(--text-color);
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-light to-gray-200 min-h-screen font-game text-dark overflow-x-hidden">
    <!-- 页面加载动画 -->
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <div class="w-20 h-20 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold text-primary">加载中...</h2>
        </div>
    </div>

    <!-- 游戏容器 -->
    <div id="game-container" class="container mx-auto px-4 py-8 hidden">
        <!-- 导航栏 -->
        <nav class="flex justify-between items-center mb-8 bg-white/80 backdrop-blur-md p-4 rounded-xl shadow-md">
            <div class="flex items-center space-x-2">
                <!-- 替换为新的logo -->
                <img src="https://gitee.com/patti-haxel/mangadm/raw/master/img/akiyama-128.ico" alt="游戏logo" class="w-8 h-8">
                <h1 class="text-2xl md:text-3xl font-bold text-primary">头顶猜词王</h1>
            </div>
            <div id="user-info" class="flex items-center space-x-4">
                <button id="ranking-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <i class="fa fa-trophy text-accent"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <i class="fa fa-moon-o text-dark"></i>
                </button>
                <span id="current-player" class="hidden md:inline-block bg-primary/10 px-3 py-1 rounded-full text-primary font-medium"></span>
                <button id="help-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <i class="fa fa-question text-dark"></i>
                </button>
                <button id="logout-btn" class="hidden bg-danger/10 hover:bg-danger/20 text-danger px-4 py-2 rounded-lg transition-colors">
                    <i class="fa fa-sign-out mr-1"></i> 退出
                </button>
            </div>
        </nav>

        <!-- 登录界面 -->
        <section id="login-screen" class="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8 transform transition-all">
            <div class="text-center mb-6">
                <i class="fa fa-users text-5xl text-primary mb-4"></i>
                <h2 class="text-3xl font-bold text-dark">欢迎你我的朋友</h2>
                <p class="text-gray-500 mt-2">和朋友们一起玩的趣味猜词游戏</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="username" class="block text-gray-700 mb-1">你的昵称</label>
                    <input type="text" id="username" placeholder="输入你的名字" 
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button id="create-room-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center">
                        <i class="fa fa-plus-circle mr-2"></i> 创建房间
                    </button>
                    <button id="join-room-btn" class="bg-accent hover:bg-accent/90 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center">
                        <i class="fa fa-sign-in mr-2"></i> 加入房间
                    </button>
                </div>
                
                <div id="room-code-input" class="hidden">
                    <label for="room-code" class="block text-gray-700 mb-1">房间代码</label>
                    <div class="flex">
                        <input type="text" id="room-code" placeholder="输入6位房间码" maxlength="6"
                            class="flex-1 px-4 py-3 rounded-l-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                        <button id="confirm-join-btn" class="bg-accent hover:bg-accent/90 text-white px-4 py-3 rounded-r-lg transition-all">
                            确认
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 text-center text-sm text-gray-500">
                <p>游戏规则：看不到自己的词，但能看到其他人的词，</p>
                <p>通过向别的玩家提问或答别的玩家问题</p>
                <p>最先猜出自己词的人获胜！</p>

            </div>
        </section>

        <!-- 房间等待界面 -->
        <section id="lobby-screen" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">房间等待中</h2>
                        <p class="text-gray-500">等待其他玩家加入...</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center bg-gray-100 px-4 py-2 rounded-lg">
                        <span class="text-gray-500 mr-2">房间代码：</span>
                        <span id="room-code-display" class="font-bold text-primary text-lg tracking-widest"></span>
                        <button id="copy-code-btn" class="ml-2 text-gray-400 hover:text-primary">
                            <i class="fa fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">当前玩家 (<span id="player-count">0</span>/<span id="max-players-display">4</span>)</h3>
                    <div id="players-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <!-- 玩家列表将在这里动态生成 -->
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1" id="max-players-container">
                        <label for="max-players" class="block text-gray-700 mb-1">玩家数量 (2-10)</label>
                        <input type="range" id="max-players" min="2" max="10" value="4" 
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                        <div class="flex justify-between text-sm text-gray-500 mt-1">
                            <span>2人</span>
                            <span id="max-players-value">4人</span>
                            <span>10人</span>
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <label for="word-category" class="block text-gray-700 mb-1">词库类别</label>
                        <select id="word-category" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none">
                            <option value="mixed">混合类别</option>
                            <option value="animals">动物</option>
                            <option value="food">食物</option>
                            <option value="movies">电影</option>
                            <option value="celebrities">名人</option>
                            <option value="objects">物品</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="start-game-btn" class="bg-secondary hover:bg-secondary/90 text-white px-8 py-3 rounded-lg transition-all pulse-button disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-play mr-2"></i> 开始游戏
                    </button>
                </div>
            </div>
        </section>

        <!-- 游戏主界面 -->
        <section id="game-screen" class="hidden">
            <!-- 游戏状态信息 -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-6 flex justify-between items-center">
                <div>
                    <span class="text-sm text-gray-500">当前回合：</span>
                    <span id="current-round" class="font-bold">第1轮</span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">当前发言：</span>
                    <span id="current-speaker" class="font-bold text-primary"></span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">已猜出：</span>
                    <span id="guessed-count">0人</span>
                </div>
            </div>
            
            <!-- 玩家区域 -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                <div id="players-container">
                    <!-- 玩家卡片将在这里动态生成 -->
                </div>
            </div>
            
            <!-- 聊天和操作区域 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 聊天区域 -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="font-bold flex items-center">
                            <i class="fa fa-comments text-primary mr-2"></i> 聊天区
                        </h3>
                    </div>
                    <div id="chat-messages" class="h-64 p-4 overflow-y-auto space-y-3">
                        <!-- 聊天消息将在这里动态生成 -->
                    </div>
                    <div class="p-4 border-t border-gray-200">
                        <div class="flex">
                            <input type="text" id="chat-input" placeholder="输入你的描述..." 
                                class="flex-1 px-4 py-2 rounded-l-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                            <button id="send-chat-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-r-lg transition-all">
                                发送
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">提示：描述其他人的词，但不要直接提及自己的词</p>
                    </div>
                </div>
                
                <!-- 操作区域 -->
                <div class="bg-white rounded-xl shadow-md p-5">
                    <h3 class="font-bold mb-4 flex items-center">
                        <i class="fa fa-gamepad text-accent mr-2"></i> 游戏操作
                    </h3>
                    
                    <div class="mb-5">
                        <p class="text-sm text-gray-500 mb-2">猜猜你头顶的词是什么？</p>
                        <div class="flex">
                            <input type="text" id="guess-input" placeholder="输入你的猜测..." 
                                class="flex-1 px-4 py-2 rounded-l-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all">
                            <button id="submit-guess-btn" class="bg-accent hover:bg-accent/90 text-white px-4 py-2 rounded-r-lg transition-all">
                                提交
                            </button>
                        </div>
                    </div>
                    
                    <div id="your-word-container" class="hidden mb-5 p-3 bg-gray-100 rounded-lg text-center">
                        <p class="text-sm text-gray-500 mb-1">你头顶的词是：</p>
                        <p id="your-word" class="font-bold text-xl text-primary"></p>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="skip-turn-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-all">
                            <i class="fa fa-forward mr-1"></i> 跳过发言
                        </button>
                        <button id="show-rules-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-all">
                            <i class="fa fa-book mr-1"></i> 查看规则
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 结果界面 -->
        <section id="results-screen" class="hidden max-w-3xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                <h2 class="text-3xl font-bold mb-6">游戏结束！</h2>
                
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">排名结果</h3>
                    <div id="ranking-list" class="space-y-3">
                        <!-- 排名列表将在这里动态生成 -->
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-secondary/10 p-4 rounded-xl">
                        <h4 class="font-bold text-secondary mb-2">胜利组 (前三名)</h4>
                        <div id="winners-list" class="flex flex-wrap justify-center gap-2">
                            <!-- 胜利者列表将在这里动态生成 -->
                        </div>
                    </div>
                    <div class="bg-danger/10 p-4 rounded-xl">
                        <h4 class="font-bold text-danger mb-2">挑战组 (后两名)</h4>
                        <div id="challengers-list" class="flex flex-wrap justify-center gap-2">
                            <!-- 挑战者列表将在这里动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="play-again-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg transition-all">
                        <i class="fa fa-refresh mr-2"></i> 再来一局
                    </button>
                    <button id="back-to-lobby-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg transition-all">
                        <i class="fa fa-home mr-2"></i> 返回房间
                    </button>
                </div>
            </div>
        </section>

        <!-- 排行榜界面 -->
        <section id="leaderboard-screen" class="hidden max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i class="fa fa-trophy text-accent mr-2"></i> 全球排行榜
                    </h2>
                    <button id="close-leaderboard-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center border-b pb-2 mb-4">
                        <div class="w-12 text-center font-bold">排名</div>
                        <div class="flex-1 font-bold">玩家</div>
                        <div class="w-24 text-center font-bold">胜率</div>
                        <div class="w-20 text-center font-bold">游戏数</div>
                        <div class="w-20 text-center font-bold">冠军数</div>
                    </div>
                    
                    <div id="leaderboard-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <!-- 排行榜数据将在这里动态生成 -->
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t">
                    <h3 class="font-bold mb-3">我的战绩</h3>
                    <div id="my-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">总游戏数</p>
                            <p id="total-games" class="text-xl font-bold">0</p>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">胜利次数</p>
                            <p id="win-count" class="text-xl font-bold">0</p>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">冠军次数</p>
                            <p id="champion-count" class="text-xl font-bold">0</p>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">胜率</p>
                            <p id="win-rate" class="text-xl font-bold">0%</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 规则模态框 -->
        <div id="rules-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto p-6 m-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">游戏规则</h3>
                    <button id="close-rules-btn" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4 text-gray-700">
                    <div>
                        <h4 class="font-bold text-primary mb-1">基本规则</h4>
                        <p>每个人头上会有一个词，但自己看不到，却能看到其他人的词</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-primary mb-1">游戏流程</h4>
                        <ol class="list-decimal pl-5 space-y-1">
                            <li>玩家轮流发言，描述自己看到的其他人的词</li>
                            <li>任何时候都可以猜自己头顶的词</li>
                            <li>猜对的玩家退出发言，但可以继续观看</li>
                            <li>所有人都猜完后游戏结束，按猜中顺序排名</li>
                        </ol>
                    </div>
                    <div>
                        <h4 class="font-bold text-primary mb-1">发言规则</h4>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>只能描述看到的其他人的词</li>
                            <li>不能直接说出任何人的词</li>
                            <li>不能暗示自己的词和其他人的词的关系</li>
                            <li>每次发言不超过30秒</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-primary mb-1">胜负判定</h4>
                        <p>按猜中顺序排名，前三名获胜，最后两名进入挑战组</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 连接到后端服务器
        const socket = io('http://124.221.17.57:3000');  // 本地开发地址
        // 生产环境应替换为实际服务器地址，如：const socket = io('https://your-server-domain.com');

        // 游戏数据
        const gameData = {
            currentScreen: 'login',
            username: '',
            userId: null,
            roomCode: '',
            isHost: false,
            players: [],
            maxPlayers: 4,
            wordCategory: 'mixed',
            currentRound: 1,
            currentSpeakerIndex: 0,
            words: {}, // {playerId: word} - 只包含其他玩家的词
            myWord: null, // 自己的词（猜对后才显示）
            guessedPlayers: [], // {playerId, rank}
            messages: [],
            stats: {
                totalGames: 0,
                wins: 0,
                champions: 0
            },
            leaderboard: []
        };

        // DOM元素
        const elements = {
            loader: document.getElementById('loader'),
            gameContainer: document.getElementById('game-container'),
            screens: {
                login: document.getElementById('login-screen'),
                lobby: document.getElementById('lobby-screen'),
                game: document.getElementById('game-screen'),
                results: document.getElementById('results-screen'),
                leaderboard: document.getElementById('leaderboard-screen')
            },
            login: {
                username: document.getElementById('username'),
                createRoomBtn: document.getElementById('create-room-btn'),
                joinRoomBtn: document.getElementById('join-room-btn'),
                roomCodeInput: document.getElementById('room-code-input'),
                roomCode: document.getElementById('room-code'),
                confirmJoinBtn: document.getElementById('confirm-join-btn')
            },
            lobby: {
                roomCodeDisplay: document.getElementById('room-code-display'),
                copyCodeBtn: document.getElementById('copy-code-btn'),
                playerCount: document.getElementById('player-count'),
                maxPlayersDisplay: document.getElementById('max-players-display'),
                playersList: document.getElementById('players-list'),
                maxPlayers: document.getElementById('max-players'),
                maxPlayersValue: document.getElementById('max-players-value'),
                maxPlayersContainer: document.getElementById('max-players-container'),
                wordCategory: document.getElementById('word-category'),
                startGameBtn: document.getElementById('start-game-btn')
            },
            game: {
                currentRound: document.getElementById('current-round'),
                currentSpeaker: document.getElementById('current-speaker'),
                guessedCount: document.getElementById('guessed-count'),
                playersContainer: document.getElementById('players-container'),
                chatMessages: document.getElementById('chat-messages'),
                chatInput: document.getElementById('chat-input'),
                sendChatBtn: document.getElementById('send-chat-btn'),
                guessInput: document.getElementById('guess-input'),
                submitGuessBtn: document.getElementById('submit-guess-btn'),
                yourWordContainer: document.getElementById('your-word-container'),
                yourWord: document.getElementById('your-word'),
                skipTurnBtn: document.getElementById('skip-turn-btn'),
                showRulesBtn: document.getElementById('show-rules-btn')
            },
            results: {
                rankingList: document.getElementById('ranking-list'),
                winnersList: document.getElementById('winners-list'),
                challengersList: document.getElementById('challengers-list'),
                playAgainBtn: document.getElementById('play-again-btn'),
                backToLobbyBtn: document.getElementById('back-to-lobby-btn')
            },
            leaderboard: {
                list: document.getElementById('leaderboard-list'),
                closeBtn: document.getElementById('close-leaderboard-btn'),
                totalGames: document.getElementById('total-games'),
                winCount: document.getElementById('win-count'),
                championCount: document.getElementById('champion-count'),
                winRate: document.getElementById('win-rate')
            },
            rulesModal: document.getElementById('rules-modal'),
            closeRulesBtn: document.getElementById('close-rules-btn'),
            helpBtn: document.getElementById('help-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            currentPlayer: document.getElementById('current-player'),
            themeToggle: document.getElementById('theme-toggle'),
            rankingBtn: document.getElementById('ranking-btn')
        };

        // 工具函数
        const utils = {
            // 获取当前玩家
            getCurrentPlayer: () => {
                return gameData.players.find(p => p.isCurrent);
            },
            
            // 检查是否是房主
            isHost: () => {
                return gameData.isHost;
            },
            
            // 检查游戏是否可以开始
            canStartGame: () => {
                return gameData.players.length >= 2 && gameData.players.length <= gameData.maxPlayers;
            },
            
            // 切换屏幕
            showScreen: (screenName) => {
                gameData.currentScreen = screenName;
                
                // 隐藏所有屏幕
                Object.values(elements.screens).forEach(screen => {
                    screen.classList.add('hidden');
                });
                
                // 显示指定屏幕
                elements.screens[screenName].classList.remove('hidden');
                
                // 更新导航栏状态
                elements.logoutBtn.classList.toggle('hidden', screenName === 'login');
                elements.currentPlayer.textContent = gameData.username;
                elements.currentPlayer.classList.toggle('hidden', screenName === 'login');
            },
            
            // 添加聊天消息
            addMessage: (username, text, isSystem = false) => {
                const message = {
                    id: Date.now(),
                    username,
                    text,
                    time: new Date()
                };
                
                gameData.messages.push(message);
                
                // 更新UI
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${isSystem ? 'justify-center' : ''}`;
                
                if (isSystem) {
                    messageElement.innerHTML = `
                        <span class="bg-gray-100 text-gray-600 text-sm px-3 py-1 rounded-full">${text}</span>
                    `;
                } else {
                    const isCurrentUser = username === gameData.username;
                    messageElement.innerHTML = `
                        <div class="${isCurrentUser ? 'ml-auto' : ''} max-w-[80%]">
                            <div class="flex ${isCurrentUser ? 'justify-end' : ''}">
                                <span class="text-xs font-semibold text-gray-500 ${isCurrentUser ? 'mr-2' : 'ml-2'}">${username}</span>
                            </div>
                            <div class="bg-${isCurrentUser ? 'primary' : 'gray-100'} text-${isCurrentUser ? 'white' : 'gray-800'} px-3 py-2 rounded-lg ${isCurrentUser ? 'rounded-tr-none' : 'rounded-tl-none'}">
                                ${text}
                            </div>
                        </div>
                    `;
                }
                
                elements.game.chatMessages.appendChild(messageElement);
                elements.game.chatMessages.scrollTop = elements.game.chatMessages.scrollHeight;
            },
            
            // 检查是否所有人都已猜完
            checkAllGuessed: () => {
                return gameData.guessedPlayers.length === gameData.players.length;
            },
            
            // 初始化排行榜数据
            initLeaderboard: () => {
                // 从localStorage加载排行榜数据
                const savedLeaderboard = localStorage.getItem('wordGuessLeaderboard');
                if (savedLeaderboard) {
                    gameData.leaderboard = JSON.parse(savedLeaderboard);
                } else {
                    gameData.leaderboard = [];
                }
                
                // 加载当前用户的统计数据
                const savedStats = localStorage.getItem(`wordGuessStats_${gameData.username}`);
                if (savedStats) {
                    gameData.stats = JSON.parse(savedStats);
                } else {
                    gameData.stats = {
                        totalGames: 0,
                        wins: 0,
                        champions: 0
                    };
                }
                
                this.updateLeaderboardUI();
            },
            
            // 更新排行榜UI
            updateLeaderboardUI: () => {
                // 排序排行榜（按胜率和冠军数）
                const sortedLeaderboard = [...gameData.leaderboard].sort((a, b) => {
                    if (b.winRate !== a.winRate) {
                        return b.winRate - a.winRate;
                    }
                    return b.champions - a.champions;
                });
                
                // 更新排行榜列表
                elements.leaderboard.list.innerHTML = '';
                sortedLeaderboard.forEach((player, index) => {
                    const isCurrentUser = player.name === gameData.username;
                    const rankElement = document.createElement('div');
                    rankElement.className = `flex items-center p-2 rounded-lg ${isCurrentUser ? 'bg-primary/10' : ''} ${index < 3 ? 'font-bold' : ''}`;
                    
                    rankElement.innerHTML = `
                        <div class="w-12 text-center ${
                            index === 0 ? 'text-yellow-500' : 
                            index === 1 ? 'text-gray-400' : 
                            index === 2 ? 'text-amber-700' : ''
                        }">${index + 1}</div>
                        <div class="flex-1">${player.name}</div>
                        <div class="w-24 text-center">${player.winRate.toFixed(1)}%</div>
                        <div class="w-20 text-center">${player.totalGames}</div>
                        <div class="w-20 text-center">${player.champions}</div>
                    `;
                    
                    elements.leaderboard.list.appendChild(rankElement);
                });
                
                // 更新个人统计
                elements.leaderboard.totalGames.textContent = gameData.stats.totalGames;
                elements.leaderboard.winCount.textContent = gameData.stats.wins;
                elements.leaderboard.championCount.textContent = gameData.stats.champions;
                
                const winRate = gameData.stats.totalGames > 0 
                    ? (gameData.stats.wins / gameData.stats.totalGames) * 100 
                    : 0;
                elements.leaderboard.winRate.textContent = winRate.toFixed(1) + '%';
            },
            
            // 更新玩家统计和排行榜
            updatePlayerStats: (rank) => {
                // 更新当前玩家统计
                gameData.stats.totalGames++;
                
                // 前三名算胜利
                if (rank <= 3) {
                    gameData.stats.wins++;
                }
                
                // 第一名是冠军
                if (rank === 1) {
                    gameData.stats.champions++;
                }
                
                // 保存到localStorage
                localStorage.setItem(`wordGuessStats_${gameData.username}`, JSON.stringify(gameData.stats));
                
                // 更新排行榜
                const winRate = (gameData.stats.wins / gameData.stats.totalGames) * 100;
                const playerIndex = gameData.leaderboard.findIndex(p => p.name === gameData.username);
                
                if (playerIndex > -1) {
                    // 更新现有玩家
                    gameData.leaderboard[playerIndex] = {
                        name: gameData.username,
                        totalGames: gameData.stats.totalGames,
                        wins: gameData.stats.wins,
                        champions: gameData.stats.champions,
                        winRate: winRate
                    };
                } else {
                    // 添加新玩家
                    gameData.leaderboard.push({
                        name: gameData.username,
                        totalGames: gameData.stats.totalGames,
                        wins: gameData.stats.wins,
                        champions: gameData.stats.champions,
                        winRate: winRate
                    });
                }
                
                // 保存排行榜
                localStorage.setItem('wordGuessLeaderboard', JSON.stringify(gameData.leaderboard));
                
                // 更新UI
                this.updateLeaderboardUI();
            },
            
            // 切换主题模式
            toggleTheme: () => {
                const isDarkMode = document.body.classList.toggle('dark-mode');
                const icon = elements.themeToggle.querySelector('i');
                
                if (isDarkMode) {
                    icon.classList.remove('fa-moon-o');
                    icon.classList.add('fa-sun-o');
                    localStorage.setItem('wordGuessTheme', 'dark');
                } else {
                    icon.classList.remove('fa-sun-o');
                    icon.classList.add('fa-moon-o');
                    localStorage.setItem('wordGuessTheme', 'light');
                }
            },
            
            // 加载保存的主题
            loadSavedTheme: () => {
                const savedTheme = localStorage.getItem('wordGuessTheme');
                const icon = elements.themeToggle.querySelector('i');
                
                if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.body.classList.add('dark-mode');
                    icon.classList.remove('fa-moon-o');
                    icon.classList.add('fa-sun-o');
                } else {
                    document.body.classList.remove('dark-mode');
                    icon.classList.remove('fa-sun-o');
                    icon.classList.add('fa-moon-o');
                }
            }
        };

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 模拟加载
            setTimeout(() => {
                elements.loader.classList.add('hidden');
                elements.gameContainer.classList.remove('hidden');
                
                // 加载保存的主题
                utils.loadSavedTheme();
                
                // 初始化排行榜
                utils.initLeaderboard();
            }, 1000);
            
            // 初始化事件监听
            initEventListeners();
            initSocketListeners();
        });

        // 初始化界面事件监听
        function initEventListeners() {
            // 登录界面事件
            elements.login.createRoomBtn.addEventListener('click', handleCreateRoom);
            elements.login.joinRoomBtn.addEventListener('click', () => {
                elements.login.roomCodeInput.classList.toggle('hidden');
            });
            elements.login.confirmJoinBtn.addEventListener('click', handleJoinRoom);
            
            // 房间界面事件
            elements.lobby.copyCodeBtn.addEventListener('click', handleCopyRoomCode);
            elements.lobby.maxPlayers.addEventListener('input', (e) => {
                gameData.maxPlayers = parseInt(e.target.value);
                elements.lobby.maxPlayersValue.textContent = `${gameData.maxPlayers}人`;
                elements.lobby.maxPlayersDisplay.textContent = gameData.maxPlayers;
                updateStartGameButton();
            });
            elements.lobby.wordCategory.addEventListener('change', (e) => {
                gameData.wordCategory = e.target.value;
            });
            elements.lobby.startGameBtn.addEventListener('click', startGame);
            
            // 游戏界面事件
            elements.game.sendChatBtn.addEventListener('click', sendChatMessage);
            elements.game.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            elements.game.submitGuessBtn.addEventListener('click', submitGuess);
            elements.game.guessInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitGuess();
            });
            elements.game.skipTurnBtn.addEventListener('click', skipTurn);
            elements.game.showRulesBtn.addEventListener('click', () => {
                elements.rulesModal.classList.remove('hidden');
            });
            
            // 结果界面事件
            elements.results.playAgainBtn.addEventListener('click', playAgain);
            elements.results.backToLobbyBtn.addEventListener('click', backToLobby);
            
            // 规则模态框事件
            elements.closeRulesBtn.addEventListener('click', () => {
                elements.rulesModal.classList.add('hidden');
            });
            elements.helpBtn.addEventListener('click', () => {
                elements.rulesModal.classList.remove('hidden');
            });
            
            // 退出按钮事件
            elements.logoutBtn.addEventListener('click', logout);
            
            // 排行榜事件
            elements.rankingBtn.addEventListener('click', () => {
                utils.initLeaderboard(); // 刷新数据
                utils.showScreen('leaderboard');
            });
            elements.leaderboard.closeBtn.addEventListener('click', () => {
                // 返回之前的屏幕
                utils.showScreen(gameData.currentScreen);
            });
            
            // 主题切换事件
            elements.themeToggle.addEventListener('click', utils.toggleTheme);
            
            // 点击模态框外部关闭
            elements.rulesModal.addEventListener('click', (e) => {
                if (e.target === elements.rulesModal) {
                    elements.rulesModal.classList.add('hidden');
                }
            });
        }

        // 初始化Socket事件监听（与后端通信）
        function initSocketListeners() {
            // 连接成功
            socket.on('connect', () => {
                console.log('已连接到服务器');
            });

            // 连接失败
            socket.on('connect_error', (error) => {
                console.error('连接服务器失败:', error);
                alert('无法连接到游戏服务器，请检查服务器是否正常运行');
            });

            // 房间创建成功
            socket.on('host-success', (data) => {
                gameData.roomCode = data.roomCode;
                gameData.players = data.players.map(p => ({
                    ...p,
                    isCurrent: p.isHost // 房主是当前用户
                }));
                gameData.userId = gameData.players.find(p => p.isCurrent).id;
                
                updateLobbyUI();
                utils.showScreen('lobby');
            });
            
            // 加入房间结果
            socket.on('join-result', (result) => {
                if (result.success) {
                    gameData.roomCode = result.roomCode;
                    gameData.players = result.players.map(p => ({
                        ...p,
                        isCurrent: !p.isHost // 非房主的那个是当前用户
                    }));
                    gameData.userId = gameData.players.find(p => p.isCurrent).id;
                    gameData.isHost = false;
                    
                    updateLobbyUI();
                    utils.showScreen('lobby');
                    utils.addMessage('系统', `成功加入房间，房主是${result.host}`, true);
                } else {
                    alert(result.message);
                }
            });
            
            // 有玩家加入房间
            socket.on('player-joined', (data) => {
                gameData.players = data.players.map(p => ({
                    ...p,
                    isCurrent: gameData.players.some(cp => cp.id === p.id)
                }));
                updateLobbyUI();
                utils.addMessage('系统', `${data.player.name}加入了房间`, true);
            });
            
            // 有玩家离开房间
            socket.on('player-left', (data) => {
                gameData.players = data.players.map(p => ({
                    ...p,
                    isCurrent: gameData.players.some(cp => cp.id === p.id)
                }));
                updateLobbyUI();
            });
            
            // 房间被关闭
            socket.on('room-closed', (data) => {
                alert(data.message);
                logout();
            });
            
            // 游戏开始
            socket.on('game-started', (data) => {
                // 初始化游戏数据
                gameData.currentRound = 1;
                gameData.currentSpeakerIndex = data.currentSpeakerIndex;
                gameData.guessedPlayers = [];
                gameData.messages = [];
                gameData.words = {};
                gameData.myWord = null;
                
                // 存储其他玩家的词（不存储自己的）
                const currentPlayer = utils.getCurrentPlayer();
                data.words.forEach(item => {
                    if (item.playerId !== currentPlayer.id) {
                        gameData.words[item.playerId] = item.word;
                    } else {
                        gameData.myWord = item.word; // 暂不显示，猜对后才显示
                    }
                });
                
                // 更新游戏界面
                updateGameUI();
                utils.showScreen('game');
                
                // 显示系统消息
                utils.addMessage('系统', '游戏开始！每个人都已获得自己的词', true);
                utils.addMessage('系统', `当前发言者：${data.players[data.currentSpeakerIndex].name}`, true);
            });
            
            // 收到新消息
            socket.on('new-message', (message) => {
                utils.addMessage(message.username, message.text);
            });
            
            // 猜词结果
            socket.on('guess-result', (data) => {
                if (data.isCorrect) {
                    // 记录猜对的玩家
                    gameData.guessedPlayers.push({
                        playerId: data.playerId,
                        rank: data.rank
                    });
                    
                    // 如果是当前玩家猜对了，显示他的词
                    const currentPlayer = utils.getCurrentPlayer();
                    if (data.playerId === currentPlayer.id) {
                        elements.game.yourWord.textContent = data.correctWord;
                        elements.game.yourWordContainer.classList.remove('hidden');
                    }
                    
                    utils.addMessage('系统', `${gameData.players.find(p => p.id === data.playerId).name}猜对了！排名第${data.rank}`, true);
                    
                    // 更新游戏界面
                    updateGameUI();
                } else {
                    alert(data.message);
                }
            });
            
            // 游戏结束
            socket.on('game-ended', (data) => {
                // 更新排名列表
                elements.results.rankingList.innerHTML = '';
                data.ranking.forEach((item, index) => {
                    const rankElement = document.createElement('div');
                    rankElement.className = `flex items-center p-3 rounded-lg ${
                        index < 3 ? 'bg-secondary/10' : 
                        index >= data.ranking.length - 2 ? 'bg-danger/10' : 'bg-gray-100'
                    }`;
                    
                    rankElement.innerHTML = `
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3 ${
                            index === 0 ? 'bg-yellow-500 text-white' : 
                            index === 1 ? 'bg-gray-400 text-white' : 
                            index === 2 ? 'bg-amber-700 text-white' : 'bg-gray-200 text-gray-800'
                        }">${index + 1}</div>
                        <div class="flex-1">
                            <p class="font-medium">${item.playerName}</p>
                            <p class="text-sm text-gray-500">词：${gameData.words[item.playerId] || gameData.myWord}</p>
                        </div>
                    `;
                    
                    elements.results.rankingList.appendChild(rankElement);
                    
                    // 如果是当前玩家，更新统计
                    const currentPlayer = utils.getCurrentPlayer();
                    if (item.playerId === currentPlayer.id) {
                        utils.updatePlayerStats(index + 1);
                    }
                });
                
                // 更新胜利者列表（前三名）
                elements.results.winnersList.innerHTML = '';
                data.ranking.slice(0, 3).forEach((item, index) => {
                    const winnerElement = document.createElement('div');
                    winnerElement.className = `flex items-center bg-white rounded-full px-3 py-1 shadow-sm`;
                    winnerElement.innerHTML = `
                        <div class="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold mr-2 ${
                            index === 0 ? 'bg-yellow-500 text-white' : 
                            index === 1 ? 'bg-gray-400 text-white' : 'bg-amber-700 text-white'
                        }">${index + 1}</div>
                        <span>${item.playerName}</span>
                    `;
                    elements.results.winnersList.appendChild(winnerElement);
                });
                
                // 更新挑战者列表（后两名）
                elements.results.challengersList.innerHTML = '';
                const challengersCount = Math.min(2, data.ranking.length);
                data.ranking.slice(-challengersCount).forEach(item => {
                    const challengerElement = document.createElement('div');
                    challengerElement.className = `flex items-center bg-white rounded-full px-3 py-1 shadow-sm`;
                    challengerElement.innerHTML = `<i class="fa fa-user text-danger mr-2"></i><span>${item.playerName}</span>`;
                    elements.results.challengersList.appendChild(challengerElement);
                });
                
                // 显示结果界面
                utils.showScreen('results');
            });
            
            // 发言者变更
            socket.on('speaker-changed', (data) => {
                gameData.currentSpeakerIndex = data.currentSpeakerIndex;
                const newSpeaker = gameData.players.find(p => p.id === data.playerId);
                elements.game.currentSpeaker.textContent = newSpeaker.name;
                
                // 提示当前发言者
                if (data.playerId === utils.getCurrentPlayer().id) {
                    utils.addMessage('系统', '现在轮到你发言了！', true);
                } else {
                    utils.addMessage('系统', `现在轮到${newSpeaker.name}发言`, true);
                }
                
                updateGameUI();
            });
            
            // 游戏重置
            socket.on('game-reset', (data) => {
                utils.addMessage('系统', data.message, true);
                updateLobbyUI();
                utils.showScreen('lobby');
            });

            // 断开连接
            socket.on('disconnect', () => {
                console.log('与服务器断开连接');
                alert('与服务器断开连接，请刷新页面重试');
            });
        }

        // 创建房间
        function handleCreateRoom() {
            const username = elements.login.username.value.trim();
            if (!username) {
                alert('请输入你的昵称');
                return;
            }
            
            gameData.username = username;
            gameData.isHost = true;
            gameData.maxPlayers = parseInt(elements.lobby.maxPlayers.value);
            gameData.wordCategory = elements.lobby.wordCategory.value;
            
            // 发送创建房间请求到服务器
            socket.emit('host-game', {
                username,
                maxPlayers: gameData.maxPlayers,
                category: gameData.wordCategory
            });
        }

        // 加入房间
        function handleJoinRoom() {
            const username = elements.login.username.value.trim();
            const roomCode = elements.login.roomCode.value.trim().toUpperCase();
            
            if (!username) {
                alert('请输入你的昵称');
                return;
            }
            
            if (!roomCode || roomCode.length !== 6) {
                alert('请输入有效的6位房间码');
                return;
            }
            
            gameData.username = username;
            
            // 发送加入房间请求到服务器
            socket.emit('join-game', {
                roomCode,
                username
            });
        }

        // 复制房间码
        function handleCopyRoomCode() {
            navigator.clipboard.writeText(gameData.roomCode).then(() => {
                const originalText = elements.lobby.copyCodeBtn.innerHTML;
                elements.lobby.copyCodeBtn.innerHTML = '<i class="fa fa-check"></i>';
                
                setTimeout(() => {
                    elements.lobby.copyCodeBtn.innerHTML = originalText;
                }, 2000);
            });
        }

        // 更新房间界面
        function updateLobbyUI() {
            elements.lobby.roomCodeDisplay.textContent = gameData.roomCode || '';
            elements.lobby.playerCount.textContent = gameData.players.length;
            elements.lobby.maxPlayersDisplay.textContent = gameData.maxPlayers;
            elements.lobby.maxPlayers.value = gameData.maxPlayers;
            elements.lobby.maxPlayersValue.textContent = `${gameData.maxPlayers}人`;
            elements.lobby.wordCategory.value = gameData.wordCategory;
            
            // 只有房主可以修改最大玩家数和开始游戏
            elements.lobby.maxPlayersContainer.classList.toggle('hidden', !utils.isHost());
            elements.lobby.startGameBtn.classList.toggle('hidden', !utils.isHost());
            
            // 更新玩家列表
            elements.lobby.playersList.innerHTML = '';
            gameData.players.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = `flex items-center bg-gray-100 rounded-lg p-3 ${player.isCurrent ? 'ring-2 ring-primary' : ''}`;
                playerElement.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-2">
                        <i class="fa fa-user"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${player.name}</p>
                        ${player.isHost ? '<p class="text-xs text-green-600">房主</p>' : ''}
                    </div>
                    ${player.isCurrent ? '<i class="fa fa-check-circle text-primary ml-2"></i>' : ''}
                `;
                elements.lobby.playersList.appendChild(playerElement);
            });
            
            // 更新开始游戏按钮状态
            updateStartGameButton();
        }

        // 更新开始游戏按钮状态
        function updateStartGameButton() {
            if (!utils.isHost()) return;
            
            const canStart = utils.canStartGame();
            elements.lobby.startGameBtn.disabled = !canStart;
        }

        // 开始游戏
        function startGame() {
            socket.emit('start-game', gameData.roomCode);
            
            // 监听开始游戏结果
            socket.once('start-game-result', (result) => {
                if (!result.success) {
                    alert(result.message);
                }
            });
        }

        // 更新游戏界面
        function updateGameUI() {
            elements.game.currentRound.textContent = `第${gameData.currentRound}轮`;
            elements.game.guessedCount.textContent = `${gameData.guessedPlayers.length}人`;
            
            // 更新当前发言者
            const currentSpeaker = gameData.players[gameData.currentSpeakerIndex];
            elements.game.currentSpeaker.textContent = currentSpeaker ? currentSpeaker.name : '';
            
            // 更新玩家卡片
            elements.game.playersContainer.innerHTML = '';
            const currentPlayer = utils.getCurrentPlayer();
            
            gameData.players.forEach(player => {
                const isGuessed = gameData.guessedPlayers.some(gp => gp.playerId === player.id);
                const isCurrentPlayer = player.isCurrent;
                const showWord = !isCurrentPlayer && !isGuessed;
                
                const playerCard = document.createElement('div');
                playerCard.className = `player-card bg-white rounded-xl shadow-md overflow-hidden ${isCurrentPlayer ? 'ring-2 ring-primary' : ''} ${isGuessed ? 'opacity-70' : ''}`;
                
                // 确定玩家的词（当前玩家看不到自己的词）
                let wordDisplay = '';
                if (showWord) {
                    wordDisplay = `<div class="bg-primary/10 py-2 px-3 text-center word-appear font-bold">${gameData.words[player.id]}</div>`;
                } else if (isCurrentPlayer && isGuessed) {
                    wordDisplay = `<div class="bg-secondary/10 py-2 px-3 text-center text-secondary font-bold">${gameData.myWord}</div>`;
                } else if (isCurrentPlayer) {
                    wordDisplay = `<div class="bg-gray-100 py-2 px-3 text-center text-gray-500">???</div>`;
                } else if (isGuessed) {
                    wordDisplay = `<div class="bg-gray-100 py-2 px-3 text-center text-gray-500 line-through">已猜出</div>`;
                }
                
                // 确定排名显示
                let rankDisplay = '';
                const playerRank = gameData.guessedPlayers.find(gp => gp.playerId === player.id);
                if (playerRank) {
                    rankDisplay = `<div class="absolute top-2 right-2 w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold ${
                        playerRank.rank === 1 ? 'bg-yellow-500' : 
                        playerRank.rank === 2 ? 'bg-gray-400' : 
                        playerRank.rank === 3 ? 'bg-amber-700' : 'bg-gray-200 text-gray-800'
                    }">${playerRank.rank}</div>`;
                }
                
                // 当前发言者指示器
                const isSpeaking = !isGuessed && gameData.players[gameData.currentSpeakerIndex]?.id === player.id;
                const speakingIndicator = isSpeaking ? `<div class="absolute top-2 left-2 w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>` : '';
                
                playerCard.innerHTML = `
                    <div class="relative">
                        ${rankDisplay}
                        ${speakingIndicator}
                        <div class="bg-gray-100 p-3 text-center">
                            <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center text-primary mx-auto mb-1">
                                <i class="fa fa-user"></i>
                            </div>
                            <p class="font-medium">${player.name}</p>
                            ${player.isHost ? '<p class="text-xs text-green-600">房主</p>' : ''}
                        </div>
                        ${wordDisplay}
                        ${isGuessed ? `<div class="bg-gray-50 text-center text-xs text-gray-500 py-1">已猜出</div>` : ''}
                    </div>
                `;
                
                elements.game.playersContainer.appendChild(playerCard);
            });
            
            // 清空聊天区域并重新添加所有消息
            elements.game.chatMessages.innerHTML = '';
            gameData.messages.forEach(msg => {
                utils.addMessage(msg.username, msg.text);
            });
        }

        // 发送聊天消息
        function sendChatMessage() {
            const text = elements.game.chatInput.value.trim();
            if (!text) return;
            
            const currentPlayer = utils.getCurrentPlayer();
            if (!currentPlayer) return;
            
            // 检查是否是当前玩家的发言回合
            const isCurrentSpeaker = gameData.players[gameData.currentSpeakerIndex]?.id === currentPlayer.id;
            if (!isCurrentSpeaker) {
                alert('等待轮到你发言');
                return;
            }
            
            // 检查玩家是否已猜完
            if (gameData.guessedPlayers.some(p => p.playerId === currentPlayer.id)) {
                alert('你已经猜出自己的词，不能再发言了');
                return;
            }
            
            // 发送消息到服务器
            socket.emit('send-message', {
                roomCode: gameData.roomCode,
                username: currentPlayer.name,
                message: text
            });
            
            elements.game.chatInput.value = '';
        }

        // 提交猜测
        function submitGuess() {
            const guess = elements.game.guessInput.value.trim();
            if (!guess) return;
            
            const currentPlayer = utils.getCurrentPlayer();
            if (!currentPlayer) return;
            
            // 检查玩家是否已猜完
            if (gameData.guessedPlayers.some(p => p.playerId === currentPlayer.id)) {
                alert('你已经猜出自己的词了');
                return;
            }
            
            // 发送猜词请求到服务器
            socket.emit('submit-guess', {
                roomCode: gameData.roomCode,
                playerId: currentPlayer.id,
                guess
            });
            
            elements.game.guessInput.value = '';
        }

        // 跳过回合
        function skipTurn() {
            const currentPlayer = utils.getCurrentPlayer();
            if (!currentPlayer) return;
            
            // 检查是否是当前玩家的发言回合
            const isCurrentSpeaker = gameData.players[gameData.currentSpeakerIndex]?.id === currentPlayer.id;
            if (!isCurrentSpeaker) {
                alert('现在不是你的回合');
                return;
            }
            
            // 检查玩家是否已猜完
            if (gameData.guessedPlayers.some(p => p.playerId === currentPlayer.id)) {
                alert('你已经猜出自己的词，不需要发言了');
                return;
            }
            
            // 发送跳过请求到服务器
            socket.emit('skip-turn', gameData.roomCode);
        }

        // 再来一局
        function playAgain() {
            if (utils.isHost()) {
                socket.emit('play-again', gameData.roomCode);
            } else {
                alert('只有房主可以开始新一局游戏');
            }
        }

        // 返回房间
        function backToLobby() {
            updateLobbyUI();
            utils.showScreen('lobby');
        }

        // 退出游戏
        function logout() {
            // 重置游戏数据
            gameData.username = '';
            gameData.userId = null;
            gameData.roomCode = '';
            gameData.isHost = false;
            gameData.players = [];
            gameData.maxPlayers = 4;
            gameData.wordCategory = 'mixed';
            
            // 清空输入框
            elements.login.username.value = '';
            elements.login.roomCode.value = '';
            elements.login.roomCodeInput.classList.add('hidden');
            
            // 显示登录界面
            utils.showScreen('login');
        }
    </script>
    <footer class="mt-12 py-6 border-t border-gray-200 text-center">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 text-gray-600">
                    <p>作者：秋山山</p>
                    <span class="hidden md:inline">|</span>
                    <p>技术支持：豆包编程助手</p>
                </div>
                <p class="mt-2 text-sm text-gray-500">© 2025 头顶猜词王 - 多人联机趣味游戏</p>
            </div>
        </footer>
</body>
</html>
